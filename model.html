<!DOCTYPE html>
<html lang="en">
<head>
   <link rel="icon" type="image/x-icon" href="/logo.ico">
<meta charset="UTF-8">
<title>Model Preview | TopNotch Assets</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html,body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Inter,system-ui,sans-serif;
}

/* VIEWER */
.viewer{height:75vh}

/* INFO BAR */
.info-bar{
  height:90px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 32px;
  background:#020617;
  border-top:1px solid rgba(255,255,255,.08);
}

.info-left h3{margin:0;font-weight:600}
.info-left p{margin:4px 0 0;font-size:13px;color:#9aa4ff}

.like{
  cursor:pointer;
  font-size:20px;
  user-select:none;
}

#downloadBtn{
  padding:14px 36px;
  border-radius:999px;
  border:none;
  font-weight:700;
  cursor:pointer;
  background:linear-gradient(90deg,#00eaff,#6f7bff);
  color:#000;
}

/* COMMENTS */
.comments{
  max-width:900px;
  margin:40px auto;
  padding:0 20px;
}

.comments h2{
  font-size:20px;
  margin-bottom:18px;
}

.comment-box{
  display:flex;
  gap:12px;
  margin-bottom:30px;
}

.comment-box textarea{
  flex:1;
  resize:none;
  padding:14px 16px;
  border-radius:12px;
  background:#020617;
  border:1px solid rgba(255,255,255,.1);
  color:#fff;
}

.comment-box button{
  padding:14px 22px;
  border-radius:12px;
  border:none;
  font-weight:600;
  cursor:pointer;
  background:linear-gradient(90deg,#6467ff,#8b5cf6);
  color:#fff;
}

.comment{
  padding:18px;
  margin-bottom:14px;
  border-radius:14px;
  background:#020617;
  border:1px solid rgba(255,255,255,.08);
}

.comment-head{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}

.comment-email{font-weight:600;font-size:14px}
.comment-time{font-size:12px;color:#9aa4ff}
.comment-text{font-size:14px;line-height:1.6}
</style>
</head>

<body>

<!-- VIEWER -->
<div class="viewer">
  <model-viewer id="viewer" camera-controls auto-rotate
    rotation-per-second="15deg" exposure="1.1"
    interaction-prompt="none" disable-pan
    style="width:100%;height:100%">
  </model-viewer>
</div>

<!-- INFO BAR -->
<div class="info-bar">
  <div class="info-left">
    <h3 id="modelName"></h3>
    <p id="modelMeta"></p>
  </div>

  <div class="like" id="likeBtn">ü§ç 0</div>
  <button id="downloadBtn">Download</button>
</div>

<!-- COMMENTS -->
<div class="comments">
  <h2>Comments</h2>

  <div class="comment-box">
    <textarea id="commentInput" rows="2" placeholder="Login to comment"></textarea>
    <button id="postBtn" disabled>Post</button>
  </div>

  <div id="commentList"></div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, updateDoc, increment,
  collection, setDoc, deleteDoc, addDoc,
  query, orderBy, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

/* INIT */
const app = initializeApp({
  apiKey: "AIzaSyBy5JEPEcplViq8AkK-_uY8JXU5iHUM6ns",
  authDomain: "top-notch-log-data.firebaseapp.com",
  projectId: "top-notch-log-data"
});
const db = getFirestore(app);
const auth = getAuth(app);

/* MODEL */
const id = new URLSearchParams(location.search).get("id");
const modelRef = doc(db, "models", id);
const snap = await getDoc(modelRef);

if (!snap.exists()) {
  alert("Model not found");
  location.href = "models.html";
}

const d = snap.data();
viewer.src = d.modelUrl;
modelName.innerText = d.name;
modelMeta.innerText = `${d.game || "Unknown"} ¬∑ ${d.category || ""}`;

const likeBtn = document.getElementById("likeBtn");
let currentUser = null;

/* AUTH */
onAuthStateChanged(auth, async user => {
  currentUser = user;
  commentInput.disabled = !user;
  postBtn.disabled = !user;
  if (user) refreshLike();
});

/* LIKE SYSTEM */
async function refreshLike() {
  const likeRef = doc(db, "models", id, "likes", currentUser.uid);
  const likeSnap = await getDoc(likeRef);
  const count = (await getDoc(modelRef)).data().likesCount || 0;
  likeBtn.innerText = likeSnap.exists() ? `‚ù§Ô∏è ${count}` : `ü§ç ${count}`;
}

likeBtn.onclick = async () => {
  if (!currentUser) return alert("Login required");

  const likeRef = doc(db, "models", id, "likes", currentUser.uid);
  const likeSnap = await getDoc(likeRef);

  if (likeSnap.exists()) {
    await deleteDoc(likeRef);
    await updateDoc(modelRef, { likesCount: increment(-1) });
  } else {
    await setDoc(likeRef, {
      uid: currentUser.uid,
      createdAt: serverTimestamp()
    });
    await updateDoc(modelRef, { likesCount: increment(1) });
  }
  refreshLike();
};

/* DOWNLOAD */
downloadBtn.onclick = async () => {
  try {
    await updateDoc(modelRef, { downloadsCount: increment(1) });
    window.open(d.downloadLink, "_blank");
  } catch (err) {
    console.error(err);
    alert("Download failed");
  }
};

/* COMMENTS */
const q = query(
  collection(db, "models", id, "comments"),
  orderBy("createdAt", "desc")
);

onSnapshot(q, snap => {
  commentList.innerHTML = "";
  snap.forEach(doc => {
    const c = doc.data();
    commentList.innerHTML += `
      <div class="comment">
        <div class="comment-head">
          <span>${c.userEmail}</span>
          <span>${timeAgo(c.createdAt?.toDate())}</span>
        </div>
        <div>${c.text}</div>
      </div>`;
  });
});

/* POST COMMENT */
postBtn.onclick = async () => {
  if (!currentUser) return;
  const text = commentInput.value.trim();
  if (!text) return;

  await addDoc(collection(db, "models", id, "comments"), {
    text,
    userEmail: currentUser.email,
    uid: currentUser.uid,
    createdAt: serverTimestamp()
  });
  commentInput.value = "";
};

function timeAgo(date) {
  if (!date) return "now";
  const s = (Date.now() - date) / 1000;
  if (s < 60) return "now";
  if (s < 3600) return Math.floor(s / 60) + "m ago";
  if (s < 86400) return Math.floor(s / 3600) + "h ago";
  return Math.floor(s / 86400) + "d ago";
}
</script>


<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</body>
</html>
