<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, updateDoc, increment,
  collection, addDoc, query, orderBy, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

/* INIT */
const app = initializeApp({
  apiKey: "AIzaSyBy5JEPEcplViq8AkK-_uY8JXU5iHUM6ns",
  authDomain: "top-notch-log-data.firebaseapp.com",
  projectId: "top-notch-log-data"
});

const db = getFirestore(app);
const auth = getAuth(app);

/* ELEMENTS */
const downloadBtn = document.getElementById("downloadBtn");
const viewer = document.getElementById("viewer");

/* DISABLE INITIALLY */
downloadBtn.disabled = true;

/* AUTH */
let currentUser = null;
onAuthStateChanged(auth, u => currentUser = u);

/* GET MODEL ID */
const id = new URLSearchParams(location.search).get("id");
if (!id) {
  alert("Invalid model ID");
  location.href = "models.html";
}

/* LOAD MODEL */
const modelRef = doc(db, "models", id);
const modelSnap = await getDoc(modelRef);

if (!modelSnap.exists()) {
  alert("Model not found");
  location.href = "models.html";
}

const model = modelSnap.data();

/* LOAD STORAGE CONFIG */
const storageRef = doc(db, "settings", "storage");
const storageSnap = await getDoc(storageRef);

if (!storageSnap.exists()) {
  console.error("settings/storage document missing");
  alert("Storage config missing");
  throw new Error("storage doc missing");
}

const storageData = storageSnap.data();

if (!storageData.r2BaseUrl) {
  console.error("r2BaseUrl field missing", storageData);
  alert("Storage URL misconfigured");
  throw new Error("r2BaseUrl missing");
}

/* CLEAN BASE URL */
const r2BaseUrl = storageData.r2BaseUrl.replace(/\/$/, "");

/* BUILD URLS */
const modelUrl = `${r2BaseUrl}/${model.modelFile}`;
const downloadUrl = `${r2BaseUrl}/${model.downloadFile}`;

/* VIEWER */
viewer.src = modelUrl;
document.getElementById("modelName").innerText = model.name;
document.getElementById("modelMeta").innerText =
  `${model.game || ""} Â· ${model.category || ""}`;

/* ENABLE DOWNLOAD */
downloadBtn.disabled = false;

/* DOWNLOAD CLICK */
downloadBtn.onclick = async () => {
  try {
    await updateDoc(modelRef, {
      downloadsCount: increment(1)
    });
    window.open(downloadUrl, "_blank");
  } catch (err) {
    console.error("Download failed:", err);
    alert("Download failed");
  }
};

/* COMMENTS */
const commentsRef = collection(db, "models", id, "comments");
const q = query(commentsRef, orderBy("createdAt", "desc"));

onSnapshot(q, snap => {
  commentList.innerHTML = "";
  snap.forEach(d => {
    const c = d.data();
    commentList.innerHTML += `
      <div class="comment">
        <b>${c.userEmail}</b>
        <p>${c.text}</p>
      </div>
    `;
  });
});

/* POST COMMENT */
postBtn.onclick = async () => {
  if (!currentUser) return;
  const text = commentInput.value.trim();
  if (!text) return;

  await addDoc(commentsRef, {
    text,
    userEmail: currentUser.email,
    createdAt: serverTimestamp()
  });

  commentInput.value = "";
};
</script>
